@model TheCoffeeShop.Models.DonHang
@{
    ViewData["Title"] = "Tạo đơn hàng";
    var donTam = ViewBag.GioHang as List<ChiTietDonHang>;
    var banTrong = ViewBag.Ban as List<Ban>;
    decimal tongTien = donTam?.Sum(m => m.SoLuong * m.DonGia) ?? 0;
}

<h2>Đơn hàng</h2>

<a asp-action="Index" class="btn btn-secondary">Quay lại danh sách món</a>

@if (donTam != null && donTam.Any())
{
    <table class="table mt-3">
        <thead>
            <tr>
                <th>Tên sản pẩm</th>
                <th>Số lượng</th>
                <th>Đơn giá</th>
                <th>Thành tiền</th>
                <th>Ghi chú</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var mon in donTam)
            {
                <tr>
                    <td>@mon.TenSanPham</td>
                    <td>@mon.SoLuong</td>
                    <td>@mon.DonGia.ToString("N0")</td>
                    <td>@(mon.SoLuong * mon.DonGia)</td>
                    <td>@mon.GhiChu</td>
                </tr>
            }
        </tbody>
    </table>

    <div class="mt-2">
        <strong>Tổng tiền: </strong> <span class="text-danger">@tongTien.ToString("N0") VNĐ</span>
    </div>
}
else
{
    <div class="alert alert-warning">Chưa có sản phẩm nào trong đơn hàng.</div>
}

<form asp-action="CreateOrder" method="post" class="mt-4">
    <div class="form-group">
        <label for="PhanLoaiDon">Phân loại đơn</label>
        <select class="form-control" id="PhanLoaiDon" name="LoaiDonHang">
            <option value="Mang đi">Mang đi</option>
            <option value="Tại quán">Tại quán</option>
        </select>
    </div>

    <div class="form-group" id="MaBanWrapper" style="display:none;">
        <label for="MaBan">Chọn bàn</label>
        @if (banTrong != null && banTrong.Any())
        {
            <select class="form-control" id="MaBan" name="MaBan">
                <option value="">-- Chọn bàn --</option>
                @foreach (var ban in banTrong)
                {
                    <option value="@ban.MaBan">@ban.TenBan</option>
                }
            </select>
        }
        else
        {
            <div class="text-danger">Không có bàn trống.</div>
        }

        @*<div class="form-group">
            <label for="TrangThai">Trạng thái đơn hàng</label>
            <select class="form-control" id="TrangThai" name="TrangThai">
                <option value="Chưa thanh toán">Chưa thanh toán</option>
                <option value="Đã thanh toán">Đã thanh toán</option>
            </select>
        </div>*@
    </div>

    <div class="form-group" id="PhuongThucWrapper">
        <label for="PhuongThucThanhToan">Phương thức thanh toán</label>
        <select class="form-control" id="PhuongThucThanhToan" name="PhuongThucThanhToan">
            <option value="Chưa thanh toán">Chưa thanh toán</option>
            <option value="Tiền mặt">Tiền mặt</option>
            <option value="Chuyển khoản">Chuyển khoản</option>
            <option value="QR Code">QR Code</option>
        </select>
    </div>

    <div class="mt-3">
        <button type="submit" name="btnThanhToan" class="btn btn-success">Thanh toán</button>
    </div>

    <div class="mt-3">
        <button type="submit" name="btnChuathanhToan" class="btn btn-success">Chưa thanh toán</button>
    </div>
</form>

<div class="text-danger mt-2">
    @Html.ValidationSummary()
</div>

@*@section Scripts {
    <script>
        const phanLoai = document.getElementById("PhanLoaiDon");
        const maBanWrapper = document.getElementById("MaBanWrapper");

        function toggleBan() {
            if (phanLoai.value === "Tại quán") {
                maBanWrapper.style.display = "block";
            } else {
                maBanWrapper.style.display = "none";
            }
        }

        phanLoai.addEventListener("change", toggleBan);
        window.addEventListener("load", toggleBan);
    </script>
}*@
@section Scripts {
    <script>
        const phanLoai = document.getElementById("PhanLoaiDon");
        const maBanWrapper = document.getElementById("MaBanWrapper");
        const phuongThucSelect = document.getElementById("PhuongThucThanhToan");
        const phuongThucWrapper = document.getElementById("PhuongThucWrapper");
        const btnThanhToan = document.querySelector("button[name='btnThanhToan']");
        const btnChuaThanhToan = document.querySelector("button[name='btnChuathanhToan']");

        function toggleBan() {
            if (phanLoai.value === "Tại quán") {
                maBanWrapper.style.display = "block";
                btnChuaThanhToan.disabled = false;
            } else {
                maBanWrapper.style.display = "none";
                btnChuaThanhToan.disabled = true;
            }
        }

        phanLoai.addEventListener("change", toggleBan);
        window.addEventListener("load", toggleBan);

        // Khi nhấn nút "Chưa thanh toán"
        btnChuaThanhToan.addEventListener("click", function () {
            phuongThucSelect.value = "Chưa thanh toán";
            phuongThucSelect.disabled = false;
        });

        // Khi nhấn nút "Thanh toán"
        btnThanhToan.addEventListener("click", function () {
            phuongThucSelect.disabled = false;
            if (phuongThucSelect.value === "Chưa thanh toán") {
                phuongThucSelect.value = "Tiền mặt";
            }
        });

        // Khi load lại trang mà đã chọn "Chưa thanh toán"
        window.addEventListener("load", function () {
            if (phuongThucSelect.value === "Chưa thanh toán") {
                phuongThucSelect.disabled = false;
            }
        });
    </script>
}

